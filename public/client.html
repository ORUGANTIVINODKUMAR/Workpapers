<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Client Management | Upsilon</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --blue: #0078d7;
      --purple: #7f56da;
      --accent-gradient: linear-gradient(90deg, #0078d7, #7f56da);
    }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f7faff 0%, #eef4ff 100%);
      min-height: 100vh;
    }
    .upsilon-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 1rem 6%; background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .upsilon-header h1 {
      font-weight: 600;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .card {
      border: none; border-radius: 16px;
      background: #fff;
      box-shadow: 0 6px 16px rgba(0,0,0,0.08);
    }
    .btn-gradient {
      background: var(--accent-gradient);
      color: #fff; border: none; border-radius: 50px;
      padding: 0.6rem 1.4rem; font-weight: 500;
    }
    .btn-gradient:hover { opacity: 0.9; }
  </style>
</head>

<body>
  <header class="upsilon-header">
    <h1>Upsilon</h1>
    <button id="logout-btn" class="btn btn-outline-danger rounded-pill px-3">Logout</button>
  </header>

  <section class="container py-5">
    <div class="card p-4 mx-auto" style="max-width: 700px;">
      <h4 class="text-center mb-4" style="background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
        Manage Clients
      </h4>

      <form id="client-form" class="mb-4">
        <input type="text" id="tp_name" class="form-control mb-3" placeholder="Taxpayer Name" required />
        <input type="text" id="sp_name" class="form-control mb-3" placeholder="Spouse Name" />
        <input type="text" id="tp_ssn" class="form-control mb-4" placeholder="SSN (Last 4 digits)" required />
        <button type="submit" class="btn-gradient w-100">Create Client</button>
      </form>

      <hr />

      <div id="client-list" class="mt-3">
        <h6 class="fw-bold mb-2 text-center">Existing Clients</h6>
        <ul class="list-group" id="clients"></ul>
      </div>
    </div>
  </section>

  <script>
    async function loadClients() {
      const res = await fetch("/clients");
      const data = await res.json();
      const list = document.getElementById("clients");
      list.innerHTML = "";

      if (data.length === 0) {
        list.innerHTML = `<li class="list-group-item text-center text-muted">No clients yet</li>`;
        return;
      }

      data.forEach(c => {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `
          <div>
            <strong>${c.tpName}</strong> (${c.ssn})<br>
            <small class="text-muted">Client ID: ${c.id}</small>
            ${c.tasks.length > 0 ? `<small class="text-muted ms-2">(${c.tasks.length} task${c.tasks.length > 1 ? 's' : ''})</small>` : ''}
          </div>
          <div>
            <button class="btn btn-sm btn-outline-primary me-2 select-btn" data-id="${c.id}">Select</button>
            <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${c.id}">Delete</button>
          </div>
        `;
        list.appendChild(li);
      });

      document.querySelectorAll(".select-btn").forEach(btn => {
        btn.addEventListener("click", async e => {
          const id = e.target.dataset.id;
          const res = await fetch(`/select-client/${id}`, { method: "POST" });
          const data = await res.json();
          if (data.success) {
            window.location.href = data.redirect;
          } else {
            alert("‚ùå Failed to select client.");
          }
        });
      });

      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", async e => {
          const id = e.target.dataset.id;
          if (confirm("Are you sure you want to delete this client?")) {
            const res = await fetch(`/client/${id}`, { method: "DELETE" });
            const data = await res.json();
            if (data.success) {
              alert("üóëÔ∏è Client deleted successfully!");
              loadClients();
            } else {
              alert("‚ùå Failed to delete client.");
            }
          }
        });
      });
    }

    document.getElementById("client-form").addEventListener("submit", async e => {
      e.preventDefault();
      const tp_name = document.getElementById("tp_name").value.trim();
      const sp_name = document.getElementById("sp_name").value.trim();
      const tp_ssn = document.getElementById("tp_ssn").value.trim();

      const res = await fetch("/client", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ tp_name, sp_name, tp_ssn })
      });

      if (res.ok) {
        const data = await res.json();
        if (data.redirect) window.location.href = data.redirect;
      } else {
        alert("‚ùå Failed to create client. Please try again.");
      }
    });

    loadClients();
  </script>

  <script src="/logout.js"></script>
</body>
</html>
