<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Tasks | Upsilon</title>

<!-- Bootstrap & Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet"/>

<style>
:root {
  --blue: #0078d7;
  --purple: #7f56da;
  --accent-gradient: linear-gradient(90deg, #0078d7, #7f56da);
}

body {
  font-family: 'Inter', sans-serif;
  background: linear-gradient(135deg, #f7faff, #eef4ff);
  color: #333;
}

/* Header */
.upsilon-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 6%;
  background: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.upsilon-header h1 {
  font-weight: 600;
  background: var(--accent-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* Buttons & Cards */
.btn-gradient {
  background: var(--accent-gradient);
  border: none;
  color: #fff;
  border-radius: 50px;
  padding: .6rem 1.2rem;
  transition: 0.3s ease;
}
.btn-gradient:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}
.card {
  border: none;
  border-radius: 16px;
  background: #fff;
  box-shadow: 0 6px 16px rgba(0,0,0,0.08);
}

/* Footer */
footer {
  background: #fff;
  border-top: 1px solid #eee;
  margin-top: 4rem;
}
.footer-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 2rem;
  padding: 3rem 10%;
}
footer a {
  text-decoration: none;
  color: #555;
}
footer a:hover {
  color: #0078d7;
}
</style>
</head>

<body>
<!-- HEADER -->
<header class="upsilon-header">
  <h1>Upsilon</h1>
  <div>
    <button onclick="window.location.href='/client'" class="btn btn-outline-secondary rounded-pill px-3 me-2">
      ‚Üê Back to Clients
    </button>
    <button id="logout-btn" class="btn btn-outline-danger rounded-pill px-3">Logout</button>
  </div>
</header>

<!-- MAIN TASK SECTION -->
<section class="container py-5">
  <div class="card p-4 mx-auto" style="max-width:750px;">
    <h4 class="text-center mb-4"
        style="background:var(--accent-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">
      Manage Merge Tasks
    </h4>

    <form id="task-form" class="d-flex mb-4">
      <input type="text" id="task_name" class="form-control me-2" placeholder="Enter Task Name" required/>
      <button type="submit" class="btn-gradient">Create</button>
    </form>

    <ul id="task-list" class="list-group list-group-flush"></ul>
  </div>
</section>

<!-- FOOTER -->
<footer>
  <div class="footer-grid">
    <div>
      <h3 style="background:var(--accent-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">
        Upsilon
      </h3>
      <p>¬© 2025 Upsilon ‚Äî Intelligent. Secure. Modern.</p>
    </div>
    <div>
      <h6>Product</h6>
      <a href="#">OCR Engine</a>
      <a href="#">Smart Merge</a>
      <a href="#">Integrations</a>
    </div>
    <div>
      <h6>Help</h6>
      <a href="#">Support</a>
      <a href="#">Docs</a>
    </div>
    <div>
      <h6>Community</h6>
      <a href="#">Partners</a>
      <a href="#">Forum</a>
    </div>
  </div>
</footer>

<!-- SCRIPT -->
<script>
async function loadTasks() {
  try {
    const res = await fetch("/tasks", { credentials: "include" });

    if (!res.ok) {
      if (res.status === 401) {
        alert("‚ö†Ô∏è Session expired. Please log in again.");
        window.location.href = "/login.html";
        return;
      }
      throw new Error("Failed to fetch tasks");
    }

    const tasks = await res.json();
    const list = document.getElementById("task-list");
    list.innerHTML = "";

    tasks.forEach(t => {
      const li = document.createElement("li");
      li.className = "list-group-item d-flex justify-content-between align-items-center";

      // Normalize status to avoid Unicode hyphen issues
      const normalized = (t.status || "").toLowerCase().replace(/[^a-z]/g, "");

      let badge = "";

      if (normalized === "inprogress") {
        badge = `<span class="badge bg-warning text-dark"><i class='bi bi-hourglass-split me-1'></i>In Process</span>`;
      }
      else if (normalized === "processing") {
        badge = `<span class="badge bg-warning text-dark"><i class='bi bi-hourglass-split me-1'></i>In Process</span>`;
      }
      else if (normalized === "completed") {
        badge = `<span class="badge bg-success"><i class='bi bi-check-circle me-1'></i>Completed</span>`;
      }
      else if (normalized === "failed") {
        badge = `<span class="badge bg-danger"><i class='bi bi-x-circle me-1'></i>Failed</span>`;
      }
      else {
        badge = `<span class="badge bg-secondary"><i class='bi bi-clock me-1'></i>Not Started</span>`;
      }

      li.innerHTML = `
        <span><strong>${t.name}</strong></span>
        <div class="d-flex align-items-center">
          <a href="/upload.html?task=${t.id}" class="btn btn-sm btn-success me-2">Open</a>
          ${t.merged ? `<a href="/download/${t.id}" class="btn btn-sm btn-outline-primary me-2">Download</a>` : ""}
          ${badge}
          <button class="btn btn-sm btn-outline-danger ms-2 delete-task" data-id="${t.id}">
            <i class="bi bi-trash"></i> Delete
          </button>
        </div>
      `;

      list.appendChild(li);
    });

  } catch (err) {
    console.error("Task load error:", err);
  }
}

// Handle new task creation
document.getElementById("task-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const name = document.getElementById("task_name").value.trim();
  if (!name) return;

  try {
    const res = await fetch("/tasks", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name }),
      credentials: "include"
    });

    if (!res.ok) throw new Error("Failed to create task");
    document.getElementById("task_name").value = "";
    loadTasks();
  } catch (err) {
    console.error(err);
    alert("Failed to create task. Please try again.");
  }
});

// Auto-refresh every 2 seconds
loadTasks();
setInterval(loadTasks, 2000);

// Handle Task Deletion
document.addEventListener("click", async (e) => {
  if (e.target.classList.contains("delete-task") || e.target.closest(".delete-task")) {
    const btn = e.target.closest(".delete-task");
    const taskId = btn.dataset.id;

    if (!confirm("üóë Are you sure you want to delete this task?")) return;

    try {
      const res = await fetch(`/tasks/${taskId}`, {
        method: "DELETE",
        credentials: "include"
      });

      const data = await res.json();
      if (data.success) {
        alert("‚úÖ Task deleted successfully!");
        loadTasks();
      } else {
        alert("‚ùå Failed to delete task: " + (data.error || "Unknown error"));
      }
    } catch (err) {
      console.error("Delete error:", err);
      alert("‚ùå Network error while deleting task.");
    }
  }
});
</script>

<script src="/logout.js"></script>
</body>
</html>
